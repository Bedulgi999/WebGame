<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Arcade</title>
  <link rel="icon" href="data:," />
  <style>
    body { margin:0; font-family:sans-serif; background:#0b1020; color:#fff; }
    .wrap { min-height:100vh; display:flex; justify-content:center; align-items:center; }
    .card { width:420px; padding:20px; border-radius:12px; background:#111836; }
    button { padding:10px; margin:6px 0; width:100%; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Web Arcade</h2>

    <div id="authBox">
      <button id="guestBtn">게스트 로그인</button>
      <button id="googleBtn">Google 로그인</button>
    </div>

    <div id="userBox" style="display:none;">
      <p id="userInfo"></p>
      <button data-game="slot">슬롯 게임</button>
      <button data-game="dodge">닷지 게임</button>
      <button id="logoutBtn">로그아웃</button>
    </div>

    <pre id="msg"></pre>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://jwkjsmlicirmuujsmdfi.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_YfPtLavytOMWG5gHr7pEDg_Dy3j8Wld";

const supabase = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: localStorage
    }
  }
);

const authBox = document.getElementById("authBox");
const userBox = document.getElementById("userBox");
const userInfo = document.getElementById("userInfo");
const msg = document.getElementById("msg");

function render(session) {
  if (!session) {
    authBox.style.display = "block";
    userBox.style.display = "none";
  } else {
    authBox.style.display = "none";
    userBox.style.display = "block";
    userInfo.textContent = `로그인됨: ${session.user.id.slice(0,8)} (${session.user.is_anonymous ? "Guest" : "Google"})`;
  }
}

const { data } = await supabase.auth.getSession();
render(data.session);

supabase.auth.onAuthStateChange((_e, session) => {
  render(session);
});

guestBtn.onclick = async () => {
  msg.textContent = "";
  const { error } = await supabase.auth.signInAnonymously();
  if (error) msg.textContent = error.message;
};

googleBtn.onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: location.origin + "/index.html" }
  });
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
};

document.querySelectorAll("[data-game]").forEach(btn => {
  btn.onclick = async () => {
    const { data } = await supabase.auth.getSession();
    if (!data.session) return alert("로그인 필요");
    location.href = `/game.html?g=${btn.dataset.game}`;
  };
});
</script>
</body>
</html>

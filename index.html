<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Arcade</title>
  <link rel="icon" href="data:," />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#070a12; color:#e9eefc; }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card {
      width:min(1100px, 100%);
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
    }
    .hrow { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    h1 { margin:0 0 10px; font-size:22px; }
    h2 { margin:0; font-size:16px; }
    p { margin:0; opacity:.85; line-height:1.5; }

    .grid { display:grid; grid-template-columns: 1.1fr 0.9fr; gap:12px; margin-top:12px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:12px;
    }

    .btn {
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color:#e9eefc;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      letter-spacing: .2px;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn.primary { background: rgba(120,200,255,0.15); border-color: rgba(120,200,255,0.35); }
    .btn.danger  { background: rgba(255,120,120,0.14); border-color: rgba(255,120,120,0.35); }
    .btn.tiny { padding:6px 10px; border-radius:10px; font-weight:900; }

    input {
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color:#e9eefc;
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }

    .msg { font-size:13px; white-space:pre-wrap; opacity:.95; margin-top:10px; }
    .msg.err { color:#ff8a8a; }
    .msg.ok { color:#8dffb3; }
    .small { font-size:12px; opacity:.78; line-height:1.4; margin-top:6px; }
    .badge { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); display:inline-flex; align-items:center; gap:8px; }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 8px; }

    table { width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
    th, td { padding:8px 8px; border-bottom:1px solid rgba(255,255,255,0.10); text-align:left; vertical-align:middle; }
    th { opacity:.85; font-weight:900; }

    tr.top1 { background: rgba(255, 80, 80, 0.18); }   /* 1ë“± ë¹¨ê°• */
    tr.top2 { background: rgba(255, 230, 80, 0.14); }  /* 2ë“± ë…¸ë‘ */
    tr.top3 { background: rgba(110, 255, 170, 0.14); } /* 3ë“± ì´ˆë¡ */

    .rankpill {
      display:inline-block;
      min-width: 44px;
      text-align:center;
      font-weight:900;
      border-radius: 999px;
      padding: 2px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.18);
    }

    /* ===== Pretty Rank Badge ===== */
    .tier {
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:950;
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      white-space:nowrap;
    }
    .tier .ic { font-size:14px; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.25)); }
    .tier-rookie   { background: linear-gradient(180deg, rgba(180,190,210,0.16), rgba(80,90,110,0.08)); border-color: rgba(200,210,230,0.18); }
    .tier-bronze   { background: linear-gradient(180deg, rgba(205,127,50,0.22), rgba(205,127,50,0.07)); border-color: rgba(205,127,50,0.25); }
    .tier-silver   { background: linear-gradient(180deg, rgba(205,220,235,0.22), rgba(150,170,190,0.08)); border-color: rgba(220,235,255,0.20); }
    .tier-gold     { background: linear-gradient(180deg, rgba(255,215,0,0.20), rgba(255,215,0,0.06)); border-color: rgba(255,215,0,0.22); }
    .tier-platinum { background: linear-gradient(180deg, rgba(150,255,240,0.18), rgba(120,200,255,0.08)); border-color: rgba(150,255,240,0.20); }
    .tier-diamond  { background: linear-gradient(180deg, rgba(160,170,255,0.18), rgba(200,120,255,0.08)); border-color: rgba(180,160,255,0.20); }
    .tier-legend   { background: linear-gradient(180deg, rgba(255,120,160,0.18), rgba(255,230,120,0.08)); border-color: rgba(255,200,160,0.22); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hrow">
        <div>
          <h1>Web Arcade</h1>
          <p>ì´ê¸°ë©´ Score/Coins â†‘, ì§€ë©´ â†“. ìŠ¬ë¡¯ì€ ì½”ì¸ ë°°íŒ…ìœ¼ë¡œ ì½”ì¸ì„ ëŠ˜ë¦´ ìˆ˜ ìˆì–´ìš”.</p>
        </div>
        <div class="badge" id="authBadge">ìƒíƒœ: í™•ì¸ ì¤‘â€¦</div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="panel">
          <h2>í”„ë¡œí•„</h2>
          <div id="profileBox" style="margin-top:10px;"></div>

          <div id="loginBox" style="margin-top:10px;">
            <div class="small">ë¡œê·¸ì¸í•˜ë©´ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”.</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
              <button class="btn" id="guestBtn">ê²ŒìŠ¤íŠ¸</button>
              <button class="btn primary" id="googleBtn">Google</button>
            </div>
            <div class="msg" id="msg"></div>
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,0.10); margin:14px 0;">

          <h2>ê²Œì„ ì„ íƒ</h2>
          <div class="small">ê²Œì„ë³„ ìŠ¹/íŒ¨ ë³´ìƒì´ ë‹¤ë¦…ë‹ˆë‹¤.</div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn" data-game="dodge">Dodge</button>
            <button class="btn" data-game="clicker">Clicker</button>
            <button class="btn" data-game="aim">Aim</button>
            <button class="btn" data-game="rhythm">Rhythm</button>
            <button class="btn" data-game="puzzle">Puzzle</button>
            <button class="btn" data-game="tetris">Tetris</button>
            <button class="btn primary" data-game="slot">Slot (ë°°íŒ…)</button>
          </div>

          <div class="small" id="rewardHint" style="margin-top:10px;"></div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="hrow">
            <h2>ìŠ¤ì½”ì–´ë³´ë“œ</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <input id="nameInput" placeholder="ë‹‰ë„¤ì„(ì œì¶œìš©)" maxlength="12" />
              <button class="btn" id="syncBtn">Sync</button>
              <button class="btn primary" id="submitBtn">ì„œë²„ ì œì¶œ</button>
            </div>
          </div>

          <div class="small">
            ì„œë²„ Top10 + ë‚´ ë¡œì»¬ ëˆ„ì  + ë‚´ ì„œë²„ ìˆœìœ„/ìµœê³  ê¸°ë¡.
            (ì„œë²„ëŠ” <b>user_idë‹¹ ìµœê³  ê¸°ë¡ë§Œ ì €ì¥</b>)
          </div>

          <div class="msg" id="rankMsg"></div>
          <div id="board"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === ë„ˆ í”„ë¡œì íŠ¸ ê°’ ===
    const SUPABASE_URL = "https://jwkjsmlicirmuujsmdfi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_YfPtLavytOMWG5gHr7pEDg_Dy3j8Wld";

    // âœ… í•¨ìˆ˜ ì´ë¦„ì´ bright-handler ë¼ì„œ URLë„ bright-handler
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/bright-handler`;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: localStorage,
      }
    });

    // ===== Local state =====
    const LS_SCORE = "arcade_total_score_v3";
    const LS_COINS = "arcade_total_coins_v3";
    const LS_NAME  = "arcade_name_v3";
    function getScore(){ return Number(localStorage.getItem(LS_SCORE)||"0")||0; }
    function getCoins(){ return Number(localStorage.getItem(LS_COINS)||"200")||200; }
    function setScore(v){ localStorage.setItem(LS_SCORE, String(Math.max(0, Math.trunc(v)))); }
    function setCoins(v){ localStorage.setItem(LS_COINS, String(Math.max(0, Math.trunc(v)))); }

    // ===== Pretty Rank =====
    function rankInfo(score){
      if(score >= 5000) return { key:"legend",   name:"LEGEND",   icon:"ğŸ‘‘" };
      if(score >= 2500) return { key:"diamond",  name:"DIAMOND",  icon:"ğŸ’" };
      if(score >= 1200) return { key:"platinum", name:"PLATINUM", icon:"âš¡" };
      if(score >= 600)  return { key:"gold",     name:"GOLD",     icon:"ğŸ…" };
      if(score >= 250)  return { key:"silver",   name:"SILVER",   icon:"ğŸ›¡ï¸" };
      if(score >= 80)   return { key:"bronze",   name:"BRONZE",   icon:"ğŸ”¥" };
      return             { key:"rookie",   name:"ROOKIE",   icon:"ğŸŒ±" };
    }
    function tierBadge(score){
      const r = rankInfo(score);
      return `<span class="tier tier-${r.key}"><span class="ic">${r.icon}</span>${r.name}</span>`;
    }

    // ===== UI refs =====
    const authBadge = document.getElementById("authBadge");
    const profileBox = document.getElementById("profileBox");
    const loginBox = document.getElementById("loginBox");
    const msgEl = document.getElementById("msg");

    const rankMsg = document.getElementById("rankMsg");
    const boardEl = document.getElementById("board");
    const nameInput = document.getElementById("nameInput");
    const rewardHint = document.getElementById("rewardHint");

    function esc(s){ return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function setMsg(el, t, ok=false){ el.className="msg "+(ok?"ok":"err"); el.textContent=t||""; }

    // ===== Game rewards =====
    const GAME_RULES = {
      dodge:  { winS: 40, loseS: -15, winC: 10, loseC: -5,  desc: "10ì´ˆ ìƒì¡´" },
      clicker:{ winS: 30, loseS: -10, winC: 5,  loseC: -3,  desc: "í´ë¦­ ëª©í‘œ" },
      aim:    { winS: 35, loseS: -12, winC: 8,  loseC: -4,  desc: "íƒ€ê²Ÿ í´ë¦­" },
      rhythm: { winS: 55, loseS: -20, winC: 12, loseC: -6,  desc: "Space íƒ€ì´ë°" },
      puzzle: { winS: 60, loseS: -25, winC: 15, loseC: -8,  desc: "í¼ì¦ ì™„ì„±" },
      tetris: { winS: 70, loseS: -30, winC: 18, loseC: -10, desc: "ë¼ì¸ 3ê°œ" },
      slot:   { winS: 10, loseS: -5,  winC: 0,  loseC: 0,   desc: "ì½”ì¸ ë°°íŒ… ìŠ¬ë¡¯" },
    };
    rewardHint.innerHTML = Object.entries(GAME_RULES).map(([k,v]) =>
      `<b>${k}</b>: WIN(S ${v.winS>=0?"+":""}${v.winS}, C ${v.winC>=0?"+":""}${v.winC}) / LOSE(S ${v.loseS}, C ${v.loseC}) - ${esc(v.desc)}`
    ).join("<br/>");

    // ===== Profile =====
    let currentSession = null;

    function avatarUrl(s){
      const md=s?.user?.user_metadata||{};
      return md.avatar_url || md.picture || null;
    }
    function displayName(s){
      const md=s?.user?.user_metadata||{};
      return md.full_name || md.name || md.email || "Guest";
    }
    function providerName(s){
      return s?.user?.app_metadata?.provider || (s?.user?.is_anonymous ? "anonymous" : "unknown");
    }

    function renderProfile(s){
      if(!s){
        authBadge.textContent = "ìƒíƒœ: ë¡œê·¸ì¸ ì•ˆ ë¨";
        profileBox.innerHTML = `<div class="small">ë¡œê·¸ì¸í•˜ë©´ í”„ë¡œí•„ì´ í‘œì‹œë¼ìš”.</div>`;
        loginBox.style.display = "block";
        return;
      }
      loginBox.style.display = "none";
      authBadge.textContent = `ìƒíƒœ: ë¡œê·¸ì¸ë¨ (${providerName(s)})`;

      const av=avatarUrl(s), dn=displayName(s), uid=s.user.id;
      const score=getScore(), coins=getCoins();
      const nick=(nameInput.value||"").trim().slice(0,12)||"Player";

      profileBox.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="width:52px;height:52px;border-radius:14px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);overflow:hidden;display:flex;align-items:center;justify-content:center;">
            ${av ? `<img src="${esc(av)}" style="width:100%;height:100%;object-fit:cover;">`
                 : `<div style="font-weight:950;opacity:.9;">${esc((dn||"U")[0]||"U")}</div>`}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:950;font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
              ${esc(dn)} ${tierBadge(score)}
            </div>
            <div class="small" style="margin-top:2px;">user_id: <code>${esc(uid.slice(0,8))}</code>â€¦</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <span class="badge">ë¡œì»¬ Score: <b>${score}</b></span>
          <span class="badge">ë¡œì»¬ Coins: <b>${coins}</b></span>
          <span class="badge">ë‹‰ë„¤ì„: <b>${esc(nick)}</b></span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      `;

      document.getElementById("logoutBtn").onclick = async ()=>{
        await supabase.auth.signOut();
        currentSession=null;
        renderProfile(null);
        renderBoard();
        setMsg(msgEl,"ë¡œê·¸ì•„ì›ƒë¨",true);
      };
    }

    // ===== Auth buttons =====
    guestBtn.onclick = async ()=>{
      setMsg(msgEl,"");
      const { error } = await supabase.auth.signInAnonymously();
      if(error){
        return setMsg(msgEl,
          "ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì‹¤íŒ¨(422ë©´ ì„¤ì • ë¬¸ì œì¼ í™•ë¥  í¼):\n" +
          error.message +
          "\n\nâœ… Supabase Dashboard > Authentication\n- Providers: Anonymous Enabled\n- Settings: Allow signups ON\n- Captcha/Bot protection OFF(ë˜ëŠ” í† í° êµ¬í˜„)\ní™•ì¸í•´ì¤˜.",
          false
        );
      }
      const { data } = await supabase.auth.getSession();
      currentSession=data.session;
      renderProfile(currentSession);
      setMsg(msgEl,"ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì„±ê³µ!",true);
    };

    googleBtn.onclick = async ()=>{
      setMsg(msgEl,"");
      const redirectTo = `${location.origin}/index.html`;
      const { error } = await supabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo } });
      if(error) setMsg(msgEl,"Google ë¡œê·¸ì¸ ì‹œì‘ ì‹¤íŒ¨:\n"+error.message,false);
    };

    supabase.auth.onAuthStateChange((_, session)=>{
      currentSession=session;
      renderProfile(currentSession);
    });

    // ===== Game entry =====
    document.querySelectorAll("[data-game]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const { data } = await supabase.auth.getSession();
        if(!data?.session){
          setMsg(msgEl,"ë¨¼ì € ë¡œê·¸ì¸í•´ì¤˜.",false);
          return;
        }
        const g = btn.getAttribute("data-game");
        location.href = `/game.html?g=${encodeURIComponent(g)}`;
      });
    });

    // ===== Edge Function helper =====
    async function callFn(body){
      const { data } = await supabase.auth.getSession();
      const token = data?.session?.access_token;
      if(!token) throw new Error("No auth session");

      const res = await fetch(FUNCTION_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
        body: JSON.stringify(body)
      });

      const j = await res.json().catch(()=> ({}));
      if(!res.ok || j.ok===false) throw new Error(j.error||j.message||("HTTP "+res.status));
      return j;
    }

    // ===== Scoreboard sorting =====
    let sortBy = "score"; // rank|score|coins|time
    let sortDir = "desc";

    let serverTop=[], serverMe=null, serverRank=null;

    function renderBoard(){
      const localScore=getScore(), localCoins=getCoins();
      const localName=(nameInput.value||"").trim().slice(0,12)||"Player";

      const rows = (serverTop||[]).map((r,i)=>({
        rank:i+1,
        name:r.name,
        score:r.best_score,
        coins:r.best_coins,
        time:r.updated_at ? new Date(r.updated_at).toLocaleString() : ""
      }));

      const head = `
      <thead>
        <tr>
          <th><button class="btn tiny" data-sort="rank">Rank ${sortBy==="rank" ? (sortDir==="asc"?"â†‘":"â†“") : ""}</button></th>
          <th>Name</th>
          <th><button class="btn tiny" data-sort="score">Score ${sortBy==="score" ? (sortDir==="asc"?"â†‘":"â†“") : ""}</button></th>
          <th><button class="btn tiny" data-sort="coins">Coins ${sortBy==="coins" ? (sortDir==="asc"?"â†‘":"â†“") : ""}</button></th>
          <th><button class="btn tiny" data-sort="time">Time ${sortBy==="time" ? (sortDir==="asc"?"â†‘":"â†“") : ""}</button></th>
        </tr>
      </thead>`;

      const myServerRow = serverMe ? `
        <tr><td colspan="5" style="opacity:.55;">â€” ë‚´ ì„œë²„ ìˆœìœ„ â€”</td></tr>
        <tr style="outline:1px solid rgba(120,200,255,0.35);">
          <td><span class="rankpill">#${serverRank ?? "-"}</span></td>
          <td>${esc(serverMe.name)} <span class="badge">ME</span> ${tierBadge(serverMe.best_score)}</td>
          <td>${serverMe.best_score}</td>
          <td>${serverMe.best_coins}</td>
          <td>${esc(new Date(serverMe.updated_at).toLocaleString())}</td>
        </tr>` : "";

      boardEl.innerHTML = `
        <table>
          ${head}
          <tbody>
            ${rows.map(r=>{
              const cls = r.rank===1?"top1":r.rank===2?"top2":r.rank===3?"top3":"";
              return `<tr class="${cls}">
                <td><span class="rankpill">#${r.rank}</span></td>
                <td>${esc(r.name)} ${tierBadge(r.score)}</td>
                <td>${r.score}</td>
                <td>${r.coins}</td>
                <td>${esc(r.time)}</td>
              </tr>`;
            }).join("")}

            ${myServerRow}

            <tr><td colspan="5" style="opacity:.55;">â€” ë‚´ ë¡œì»¬ ëˆ„ì  â€”</td></tr>
            <tr>
              <td><span class="rankpill">ME</span></td>
              <td>${esc(localName)} (local) ${tierBadge(localScore)}</td>
              <td>${localScore}</td>
              <td>${localCoins}</td>
              <td>-</td>
            </tr>
          </tbody>
        </table>
      `;

      boardEl.querySelectorAll("[data-sort]").forEach(b=>{
        b.onclick = async ()=>{
          const k = b.getAttribute("data-sort");
          if (sortBy === k) sortDir = (sortDir === "asc" ? "desc" : "asc");
          else { sortBy = k; sortDir = "desc"; }
          await syncAll();
        };
      });
    }

    async function syncAll(){
      setMsg(rankMsg,"ì„œë²„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      try{
        const top = await callFn({ action:"top", limit:10, sortBy, sortDir });
        serverTop = top.data || [];
        const me = await callFn({ action:"me" });
        serverMe = me.me || null;
        serverRank = me.rank || null;

        setMsg(rankMsg,`ì„œë²„ ë™ê¸°í™” ì™„ë£Œ (ì •ë ¬: ${sortBy.toUpperCase()} ${sortDir.toUpperCase()})`,true);
        renderBoard();
      }catch(e){
        setMsg(rankMsg,"Sync ì‹¤íŒ¨: "+(e?.message||e),false);
      }
    }

    async function submitBest(){
      setMsg(rankMsg,"ì„œë²„ì— ì œì¶œ ì¤‘(ìµœê³  ê¸°ë¡ë§Œ ì €ì¥)...");
      try{
        const { data } = await supabase.auth.getSession();
        if(!data?.session) return setMsg(rankMsg,"ë¨¼ì € ë¡œê·¸ì¸í•´ì¤˜.",false);

        const name=(nameInput.value||"").trim().slice(0,12)||"Player";
        await callFn({ action:"submit", name, score:getScore(), coins:getCoins() });

        setMsg(rankMsg,"ì œì¶œ ì™„ë£Œ. Sync ì¤‘...",true);
        await syncAll();
      }catch(e){
        setMsg(rankMsg,"ì œì¶œ ì‹¤íŒ¨: "+(e?.message||e),false);
      }
    }

    document.getElementById("syncBtn").onclick = syncAll;
    document.getElementById("submitBtn").onclick = submitBest;

    // ===== Receive game result =====
    const u = new URL(location.href);
    const result = u.searchParams.get("result");
    const gameFrom = u.searchParams.get("g") || "";
    const ds = Number(u.searchParams.get("ds")||"0");
    const dc = Number(u.searchParams.get("dc")||"0");

    if(result==="win"||result==="lose"){
      setScore(getScore()+ds);
      setCoins(getCoins()+dc);
      setMsg(msgEl,
        `ê²Œì„: ${gameFrom}\nê²°ê³¼: ${result.toUpperCase()}\nScore ë³€í™”: ${ds>=0?"+":""}${ds}\nCoins ë³€í™”: ${dc>=0?"+":""}${dc}\nëˆ„ì  Score=${getScore()} / Coins=${getCoins()}`,
        true
      );
      ["result","g","ds","dc"].forEach(k=>u.searchParams.delete(k));
      history.replaceState({}, "", u.pathname + (u.searchParams.toString()?("?"+u.searchParams.toString()):""));
    }

    // nickname local
    const savedName = localStorage.getItem(LS_NAME);
    if(savedName) nameInput.value = savedName;
    nameInput.addEventListener("input", ()=>{
      localStorage.setItem(LS_NAME, (nameInput.value||"").trim().slice(0,12));
      renderProfile(currentSession);
      renderBoard();
    });

    // init
    const init = await supabase.auth.getSession();
    currentSession = init.data?.session || null;
    renderProfile(currentSession);
    renderBoard();
  </script>
</body>
</html>

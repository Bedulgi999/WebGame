<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Arcade - Game</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" href="data:," />
</head>
<body>
  <div class="wrap" style="align-items:flex-start;">
    <div class="card">
      <div class="hrow">
        <div>
          <h1 id="title">Game</h1>
          <div class="small" id="desc"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="backBtn">허브로</button>
          <button class="btn" id="restartBtn">재시작</button>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>플레이</h2>
          <div class="gamebox">
            <canvas id="c"></canvas>
          </div>
          <div class="msg" id="msg"></div>
          <div class="small" id="hud"></div>
        </div>

        <div class="panel">
          <h2>규칙</h2>
          <div class="small">
            • 승리하면 허브로 돌아가며 <b>?result=win</b> 전달<br/>
            • 죽으면 허브로 돌아가며 <b>?result=lose</b> 전달<br/>
            • 허브가 누적 점수를 업데이트함
          </div>
          <hr style="border:0; border-top:1px solid rgba(255,255,255,0.10); margin:12px 0;">
          <div class="small">
            팁: 이 페이지는 “게임만 담당”. 점수/랭킹은 index.html에서 관리합니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ✅ 같은 프로젝트 값 (세션 체크용)
    const SUPABASE_URL = "https://jwkjsmlicirmuujsmdfi.supabase.co";
    const SUPABASE_ANON_KEY = "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";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const titleEl = document.getElementById("title");
    const descEl = document.getElementById("desc");
    const msgEl = document.getElementById("msg");
    const hudEl = document.getElementById("hud");
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");

    function setMsg(text, ok=false) {
      msgEl.className = "msg " + (ok ? "ok" : "err");
      msgEl.textContent = text || "";
    }

    // 로그인 체크 (허브에서만 시작하게)
    const { data } = await supabase.auth.getSession();
    if (!data?.session) location.href = "/index.html";

    const qs = new URLSearchParams(location.search);
    const g = qs.get("g") || "dodge";

    document.getElementById("backBtn").onclick = () => location.href = "/index.html";
    document.getElementById("restartBtn").onclick = () => start();

    // Canvas sizing (CSS px 기반)
    function resize() {
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    addEventListener("resize", resize);

    // Common helpers
    function rand(a,b){ return a + Math.random()*(b-a); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function dist(x1,y1,x2,y2){ return Math.hypot(x1-x2, y1-y2); }

    let state = null;
    let raf = 0;
    let last = 0;

    function end(result) {
      cancelAnimationFrame(raf);
      setMsg(result === "win" ? "WIN! 허브로 돌아갑니다." : "LOSE! 허브로 돌아갑니다.", result==="win");
      setTimeout(() => {
        location.href = `/index.html?result=${encodeURIComponent(result)}`;
      }, 650);
    }

    // =============================
    // Game 1: Dodge (10초 생존)
    // =============================
    function gameDodgeInit(w,h) {
      titleEl.textContent = "Dodge";
      descEl.textContent = "10초 동안 장애물을 피하면 승리. (WASD/방향키 이동)";
      return {
        t: 0,
        duration: 10,
        player: { x: w*0.5, y: h*0.78, r: 14 },
        balls: []
      };
    }

    function gameDodgeStep(s, dt, w, h, keys) {
      s.t += dt;
      const p = s.player;
      const spd = 260;

      const dx = (keys.left?-1:0) + (keys.right?1:0);
      const dy = (keys.up?-1:0) + (keys.down?1:0);
      p.x = clamp(p.x + dx*spd*dt, p.r, w - p.r);
      p.y = clamp(p.y + dy*spd*dt, p.r, h - p.r);

      // spawn
      if (Math.random() < 2.2 * dt) {
        s.balls.push({ x: rand(20, w-20), y: -20, r: rand(10, 18), vy: rand(140, 260) });
      }

      // update
      for (const b of s.balls) b.y += b.vy * dt;
      s.balls = s.balls.filter(b => b.y < h + 30);

      // collision
      for (const b of s.balls) {
        if (dist(b.x,b.y,p.x,p.y) < b.r + p.r) return "lose";
      }
      if (s.t >= s.duration) return "win";
      return null;
    }

    function gameDodgeDraw(s, w, h) {
      // bg
      ctx.fillStyle = "#091022";
      ctx.fillRect(0,0,w,h);

      // player
      ctx.fillStyle = "rgba(120,200,255,0.95)";
      ctx.beginPath(); ctx.arc(s.player.x, s.player.y, s.player.r, 0, Math.PI*2); ctx.fill();

      // balls
      ctx.fillStyle = "rgba(255,120,180,0.92)";
      for (const b of s.balls) { ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }

      hudEl.textContent = `남은 시간: ${(s.duration - s.t).toFixed(1)}s`;
    }

    // =============================
    // Game 2: Clicker (8초 25클릭)
    // =============================
    function gameClickerInit(w,h) {
      titleEl.textContent = "Clicker";
      descEl.textContent = "8초 안에 25번 클릭하면 승리. (캔버스를 클릭!)";
      return { t:0, duration: 8, goal: 25, clicks: 0 };
    }

    function gameClickerStep(s, dt) {
      s.t += dt;
      if (s.clicks >= s.goal) return "win";
      if (s.t >= s.duration) return "lose";
      return null;
    }

    function gameClickerDraw(s, w, h) {
      ctx.fillStyle = "#0a1126";
      ctx.fillRect(0,0,w,h);

      const progress = clamp(s.clicks / s.goal, 0, 1);
      ctx.fillStyle = "rgba(120,200,255,0.22)";
      ctx.fillRect(30, h*0.55, (w-60)*progress, 18);

      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.strokeRect(30, h*0.55, w-60, 18);

      ctx.fillStyle = "rgba(233,238,252,0.95)";
      ctx.font = "20px system-ui";
      ctx.fillText(`Clicks: ${s.clicks}/${s.goal}`, 30, h*0.45);

      hudEl.textContent = `남은 시간: ${(s.duration - s.t).toFixed(1)}s (클릭해서 채우기!)`;
    }

    // =============================
    // Game 3: Aim (10초 8타겟)
    // =============================
    function gameAimInit(w,h) {
      titleEl.textContent = "Aim";
      descEl.textContent = "10초 안에 8개 타겟을 맞히면 승리. (타겟을 클릭!)";
      return { t:0, duration: 10, goal: 8, hits:0, target: spawnTarget(w,h) };
    }

    function spawnTarget(w,h){
      return { x: rand(60, w-60), y: rand(70, h-70), r: rand(18, 28) };
    }

    function gameAimStep(s, dt, w, h) {
      s.t += dt;
      if (s.hits >= s.goal) return "win";
      if (s.t >= s.duration) return "lose";
      // 타겟은 정지, 클릭으로만 바뀜
      return null;
    }

    function gameAimDraw(s, w, h) {
      ctx.fillStyle = "#091022";
      ctx.fillRect(0,0,w,h);

      // target
      ctx.fillStyle = "rgba(255,230,80,0.22)";
      ctx.beginPath(); ctx.arc(s.target.x, s.target.y, s.target.r+10, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = "rgba(255,230,80,0.55)";
      ctx.beginPath(); ctx.arc(s.target.x, s.target.y, s.target.r, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = "rgba(233,238,252,0.95)";
      ctx.font = "20px system-ui";
      ctx.fillText(`Hits: ${s.hits}/${s.goal}`, 30, 40);

      hudEl.textContent = `남은 시간: ${(s.duration - s.t).toFixed(1)}s`;
    }

    // ---- Input ----
    const key = { left:false,right:false,up:false,down:false };
    addEventListener("keydown", (e) => {
      if (e.code==="ArrowLeft"||e.code==="KeyA") key.left=true;
      if (e.code==="ArrowRight"||e.code==="KeyD") key.right=true;
      if (e.code==="ArrowUp"||e.code==="KeyW") key.up=true;
      if (e.code==="ArrowDown"||e.code==="KeyS") key.down=true;
    });
    addEventListener("keyup", (e) => {
      if (e.code==="ArrowLeft"||e.code==="KeyA") key.left=false;
      if (e.code==="ArrowRight"||e.code==="KeyD") key.right=false;
      if (e.code==="ArrowUp"||e.code==="KeyW") key.up=false;
      if (e.code==="ArrowDown"||e.code==="KeyS") key.down=false;
    });

    canvas.addEventListener("click", (ev) => {
      if (!state) return;
      const rect = canvas.getBoundingClientRect();
      const x = (ev.clientX - rect.left);
      const y = (ev.clientY - rect.top);

      if (g === "clicker") {
        state.clicks++;
      } else if (g === "aim") {
        if (dist(x,y,state.target.x,state.target.y) <= state.target.r) {
          state.hits++;
          state.target = spawnTarget(rect.width, rect.height);
        }
      }
    });

    function start() {
      cancelAnimationFrame(raf);
      resize();

      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;

      if (g === "dodge") state = gameDodgeInit(w,h);
      else if (g === "clicker") state = gameClickerInit(w,h);
      else state = gameAimInit(w,h);

      setMsg("게임 시작!", true);
      last = performance.now();
      loop(last);
    }

    function loop(now) {
      const dt = Math.min(0.033, (now - last)/1000);
      last = now;

      const rect = canvas.getBoundingClientRect();
      const w = rect.width, h = rect.height;

      let result = null;
      if (g === "dodge") result = gameDodgeStep(state, dt, w, h, key);
      else if (g === "clicker") result = gameClickerStep(state, dt, w, h);
      else result = gameAimStep(state, dt, w, h);

      if (g === "dodge") gameDodgeDraw(state, w, h);
      else if (g === "clicker") gameClickerDraw(state, w, h);
      else gameAimDraw(state, w, h);

      if (result) return end(result);
      raf = requestAnimationFrame(loop);
    }

    start();
  </script>
</body>
</html>
